
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="/theme/pygments/xcode.min.css">
  <link rel="stylesheet" type="text/css" href="/theme/font-awesome/css/font-awesome.min.css">

    <link href="/static/custom.css" rel="stylesheet">



    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index, follow" />


<meta name="author" content="Ashley Arthur" />
<meta name="description" content="The traditional flow for restoring view controllers in UIKit goes likes this: (Required) Assign restoration identifiers to the view controllers (Required) Tell iOS how to create or locate new view controller objects at launch time. (Optional) Encode current State for later restoration Recreating the hierarchy of view controllers is indeed easy and mostly automated but a lot of the articles out there gloss over how to restore their dependencies (hint: Grabbing references to singletons in the VC’s decodeRestorableState method is not the correct answer!)">
<meta name="keywords" content="Swift, iOS">
<meta property="og:site_name" content="Tech Notes"/>
<meta property="og:title" content="Restoring ViewControllers and their Data sources (WIP)"/>
<meta property="og:description" content="The traditional flow for restoring view controllers in UIKit goes likes this: (Required) Assign restoration identifiers to the view controllers (Required) Tell iOS how to create or locate new view controller objects at launch time. (Optional) Encode current State for later restoration Recreating the hierarchy of view controllers is indeed easy and mostly automated but a lot of the articles out there gloss over how to restore their dependencies (hint: Grabbing references to singletons in the VC’s decodeRestorableState method is not the correct answer!)">
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="/restoring-viewcontrollers-and-their-data-sources-wip.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-11-25 00:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="/author/ashley-arthur.html">
<meta property="article:section" content="Tech"/>
<meta property="article:tag" content="Swift"/>
<meta property="article:tag" content="iOS"/>
<meta property="og:image" content="/images/portrait.jpg">

  <title>Tech Notes &ndash; Restoring ViewControllers and their Data sources (WIP)</title>

</head>
<body>
  <aside>
    <div>
      <a href="">
        <img src="/images/portrait.jpg" alt="Ashley Arthur" title="Ashley Arthur">
      </a>
      <h1><a href="">Ashley Arthur</a></h1>

<p>Tech notes and Discoveries</p>

      <ul class="social">
        <li><a class="sc-linkedin" href="https://uk.linkedin.com/in/ashley-arthur-4a918635" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-github" href="https://github.com/ash30" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-flickr" href="https://www.flickr.com/photos/ash30/" target="_blank"><i class="fa fa-flickr"></i></a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
    <h1 id="restoring-viewcontrollers-and-their-data-sources-wip">Restoring ViewControllers and their Data sources (WIP)</h1>
    <p>
          Posted on Fri 25 November 2016 in <a href="/category/tech.html">Tech</a>


    </p>
  </header>


  <div>
    <p>The traditional flow for restoring view controllers in UIKit goes likes this:</p>
<ol>
<li>(Required) Assign restoration identifiers to the view controllers</li>
<li>(Required) Tell iOS how to create or locate new view controller objects at launch time.</li>
<li>(Optional) Encode current State for later restoration</li>
</ol>
<p>Recreating the hierarchy of view controllers is indeed easy and mostly automated 
but a lot of the articles out there gloss over how to restore their dependencies
(hint: Grabbing references to singletons in the VC’s decodeRestorableState method is not the correct answer!)</p>
<p>Normally you pass dependencies like a baton between controllers. When restoring a controller,
the segue isn’t called and you get an ‘empty’ controller and its up to you to restore the dependencies.
It turns out the data source can adopt the same state restoring protocol as the view controller and come along for the ride.  </p>
<h2>Assign restoration ids for dependencies</h2>
<p>Normally as apart of the app launch you’ll have some code to initialise 
backing data sources for your view controllers. As a small extension to this routine,
we also now have to give them an ID so that the VC’s can indirectly reference them on app restore.</p>
<p>The app delegate method <strong>willFinishLaunchingWithOptions</strong> is called after bootstrapping 
but before the restoration process so is a good place to register objects. </p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nf">application</span><span class="p">(</span><span class="kc">_</span> <span class="n">application</span><span class="p">:</span> <span class="bp">UIApplication</span><span class="p">,</span> <span class="n">willFinishLaunchingWithOptions</span> <span class="n">launchOptions</span><span class="p">:</span> <span class="p">[</span><span class="n">UIApplicationLaunchOptionsKey</span> <span class="p">:</span> <span class="nb">Any</span><span class="p">]?</span> <span class="p">=</span> <span class="kc">nil</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>

    <span class="c1">// Register Data Source</span>

    <span class="bp">UIApplication</span><span class="p">.</span><span class="n">registerObject</span><span class="p">(</span>
      <span class="n">forStateRestoration</span><span class="p">:</span> <span class="n">dataStore</span><span class="p">,</span>
      <span class="n">restorationIdentifier</span><span class="p">:</span> <span class="s">&quot;DataSource&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>
</pre></div>


<h2>Tell iOS how to create or locate the dependency</h2>
<p>Any registered dependency must conform to ‘UIStateRestoring’ protocol 
(UIViewControllers automatically conform to this) and allows you to define a restoration class</p>
<div class="highlight"><pre><span></span><span class="kr">optional</span> <span class="kd">var</span> <span class="nv">objectRestorationClass</span><span class="p">:</span> <span class="bp">UIObjectRestoration</span><span class="p">.</span><span class="kr">Type</span><span class="p">?</span> <span class="p">{</span> <span class="kr">get</span> <span class="p">}</span>
</pre></div>


<p>If you return nil from this method, UIKIT assumes the app startup code recreated 
the dependency already and will be able to find it as you’ve registered it to a restoration id.</p>
<p>If you do specify a restoration class, it needs to define the following static method:</p>
<div class="highlight"><pre><span></span><span class="kd">static</span> <span class="kd">func</span> <span class="nf">object</span><span class="p">(</span><span class="n">withRestorationIdentifierPath</span> <span class="n">identifierComponents</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">],</span> <span class="n">coder</span><span class="p">:</span> <span class="bp">NSCoder</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="bp">UIStateRestoring</span><span class="p">?</span>
</pre></div>


<p>It can return a reference to a global, init a new instance or return nil if no restoration is possible. </p>
<h2>Restoring the Dependency as part of the Controller Decode Process</h2>
<p>Now when you restore the view controllers state, any request to decode the 
datasources’s restoration id will simply be passed the registered instance.
Voila! You can now reconstruct the VC’s dependencies.</p>
<div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">controller</span> <span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">decodeRestorableState</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="bp">NSCoder</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">super</span><span class="p">.</span><span class="n">decodeRestorableState</span><span class="p">(</span><span class="n">with</span><span class="p">:</span> <span class="n">with</span><span class="p">)</span>
        <span class="n">guard</span>
            <span class="kd">let</span> <span class="nv">object</span> <span class="p">=</span> <span class="n">with</span><span class="p">.</span><span class="n">decodeObject</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="s">&quot;DataSource&quot;</span><span class="p">),</span> <span class="c1">// Any </span>
            <span class="kd">let</span> <span class="nv">dataSource</span> <span class="p">=</span> <span class="n">object</span> <span class="kc">as</span><span class="p">?</span> <span class="n">DateSourceKlass</span> 
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span>
        <span class="p">}</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">dataSource</span> <span class="p">=</span> <span class="n">dataSource</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>The one draw back to this approach, as others have noted, is how it separates 
Controller Restoration and Dependency Restoration into 2 distinct phases. 
You’ve just lost your paddle if you’ve declared your dependencies as const.
I think this hints at UIKits own opinion that controllers don’t actually own 
their datasources and so should be declared weakly.</p>
<h2>References</h2>
<ul>
<li><a href="https://developer.apple.com/videos/play/wwdc2013/222/">https://developer.apple.com/videos/play/wwdc2013/222/</a></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="/tag/swift.html">Swift</a>
      <a href="/tag/ios.html">iOS</a>
    </p>
  </div>




</article>

    <footer>
<p>&copy; Ashley Arthur 2016</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Tech Notes ",
  "url" : "",
  "image": "/images/portrait.jpg",
  "description": "Ashley Arthur's Thoughts and Writings"
}
</script>
</body>
</html>
